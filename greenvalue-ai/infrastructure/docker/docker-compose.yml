# ============================================================
# GREENVALUE AI - Full Stack Docker Compose
# ============================================================
# Architecture: 7-Layer Enterprise Stack
# Hardware Target: NVIDIA RTX 5070 Ti (Dev) / GTX 1650 Ti (Prod)
# Strategy: Zero Cost / Bootstrap (Self-hosted everything)
# ============================================================

services:
  # ============================================================
  # Layer 5: PostgreSQL 16 + PostGIS (Primary Spatial DB)
  # Port: 5432
  # ============================================================
  postgres:
    image: postgis/postgis:16-3.4
    container_name: greenvalue-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-greenvalue}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-greenvalue_secret}
      - POSTGRES_DB=${POSTGRES_DB:-greenvalue}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init-postgis.sql:/docker-entrypoint-initdb.d/01-init-postgis.sql:ro
    networks:
      - greenvalue-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-greenvalue} -d ${POSTGRES_DB:-greenvalue}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Cache & Queue: Redis Stack (BullMQ + Session Caching)
  # Port: 6379
  # ============================================================
  redis:
    image: redis/redis-stack:latest
    container_name: greenvalue-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
      - "8001:8001"    # RedisInsight UI (Dev only)
    volumes:
      - redis-data:/data
    environment:
      - REDIS_ARGS=--appendonly yes --maxmemory 2gb --maxmemory-policy noeviction
    networks:
      - greenvalue-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 6: MinIO (S3-Compatible Object Storage)
  # API: 9000 | Console: 9001
  # Buckets: raw-uploads, pdf-reports, ai-heatmaps
  # ============================================================
  minio:
    image: minio/minio
    container_name: greenvalue-minio
    restart: unless-stopped
    ports:
      - "9000:9000"    # S3 API
      - "9001:9001"    # Web Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-greenvalue}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-greenvalue_secret}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - greenvalue-net
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MinIO Init: Create default buckets on first startup
  # ============================================================
  minio-init:
    image: minio/mc
    container_name: greenvalue-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set greenvalue http://minio:9000 $${MINIO_ROOT_USER:-greenvalue} $${MINIO_ROOT_PASSWORD:-greenvalue_secret};
      mc mb greenvalue/raw-uploads --ignore-existing;
      mc mb greenvalue/pdf-reports --ignore-existing;
      mc mb greenvalue/ai-heatmaps --ignore-existing;
      mc anonymous set download greenvalue/pdf-reports;
      echo 'MinIO buckets initialized successfully';
      exit 0;
      "
    networks:
      - greenvalue-net

  # ============================================================
  # Layer 3: NestJS Backend (Application Core - Modular Monolith)
  # Host Port: 4000 -> Container Port: 3000
  # Modules: Property, Valuation Engine, Marketplace, Auth
  # ============================================================
  greenvalue-be:
    build:
      context: ./greenvalue-be
      dockerfile: Dockerfile
    container_name: greenvalue-backend
    restart: unless-stopped
    ports:
      - "4000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-greenvalue}:${POSTGRES_PASSWORD:-greenvalue_secret}@postgres:5432/${POSTGRES_DB:-greenvalue}?schema=public
      - DIRECT_URL=postgresql://${POSTGRES_USER:-greenvalue}:${POSTGRES_PASSWORD:-greenvalue_secret}@postgres:5432/${POSTGRES_DB:-greenvalue}?schema=public
      - REDIS_URL=redis://redis:6379
      - AI_SERVICE_URL=http://greenvalue-ai:8000
      - AI_GRPC_HOST=greenvalue-ai
      - AI_GRPC_PORT=50051
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-greenvalue}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-greenvalue_secret}
      - MINIO_BUCKET_UPLOADS=raw-uploads
      - MINIO_BUCKET_REPORTS=pdf-reports
      - MINIO_BUCKET_HEATMAPS=ai-heatmaps
      - JWT_SECRET=${JWT_SECRET:-greenvalue_jwt_secret_change_me}
      - JWT_EXPIRATION=7d
      - ENABLE_SWAGGER=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - greenvalue-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/v1/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 4: AI Engine (Python FastAPI - GPU Enabled)
  # Port: 8000 (HTTP) | 50051 (gRPC) | 9090 (Metrics)
  # - YOLOv11 Instance Segmentation
  # - Physics Engine (U-Value Calculation)
  # - GPU Acceleration (CUDA 12.4)
  # ============================================================
  greenvalue-ai:
    build:
      context: ./greenvalue-ai
      dockerfile: infrastructure/docker/Dockerfile
    container_name: greenvalue-ai-engine
    restart: unless-stopped
    ports:
      - "8000:8000"    # FastAPI HTTP
      - "50051:50051"  # gRPC
      - "9090:9090"    # Prometheus Metrics
    environment:
      # GPU & Performance
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:256

      # YOLO Model (m=Medium for 1650Ti, x=Extra for 5070Ti)
      - YOLO_MODEL_SIZE=${YOLO_MODEL_SIZE:-m}

      # Application
      - APP_ENV=${APP_ENV:-production}
      - REDIS_URL=redis://redis:6379
      - QDRANT_URL=http://qdrant:6333
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONPATH=/app

      # MinIO Connection (Download images, Upload heatmaps & PDFs)
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-greenvalue}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-greenvalue_secret}
      - MINIO_SECURE=false
      - MINIO_BUCKET_UPLOADS=raw-uploads
      - MINIO_BUCKET_REPORTS=pdf-reports
      - MINIO_BUCKET_HEATMAPS=ai-heatmaps

      # PostgreSQL (Direct DB access for AI results)
      - DATABASE_URL=postgresql://${POSTGRES_USER:-greenvalue}:${POSTGRES_PASSWORD:-greenvalue_secret}@postgres:5432/${POSTGRES_DB:-greenvalue}
    volumes:
      # DEV VOLUME: Mount source code so changes don't require rebuild
      - ./greenvalue-ai:/app
      # Persistent data: YOLO weights, trained models, logs
      - ai-models:/app/data/models
      - ai-yolo-weights:/app/data/yolo_weights
      - ai-logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - greenvalue-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # GPU Reservation (Required for CUDA)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ============================================================
  # Vector Database: Qdrant (Visual Similarity Search)
  # Port: 6333 (HTTP) | 6334 (gRPC)
  # Feature: "Homes Like This"
  # ============================================================
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: greenvalue-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"    # HTTP API
      - "6334:6334"    # gRPC API
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - greenvalue-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MLOps: MLflow (Model Registry & Experiment Tracking)
  # Port: 5000
  # ============================================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.18.0
    container_name: greenvalue-mlflow
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=sqlite:///mlflow/mlflow.db
      - MLFLOW_ARTIFACT_ROOT=/mlflow/artifacts
    volumes:
      - mlflow-data:/mlflow
    command: >
      mlflow server
      --backend-store-uri sqlite:///mlflow/mlflow.db
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
    networks:
      - greenvalue-net
    profiles:
      - ml
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 2: Nginx Reverse Proxy (SSL Termination & Load Balancing)
  # Ports: 80 (HTTP) | 443 (HTTPS)
  # ============================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: greenvalue-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./greenvalue-ai/infrastructure/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./greenvalue-ai/infrastructure/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - greenvalue-be
      - greenvalue-ai
    networks:
      - greenvalue-net
    profiles:
      - gateway
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 7: Prometheus (Metrics Collection)
  # Port: 9091
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: greenvalue-prometheus
    restart: unless-stopped
    ports:
      - "9091:9090"
    volumes:
      - ./greenvalue-ai/infrastructure/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./greenvalue-ai/infrastructure/monitoring/prometheus/alerting_rules.yml:/etc/prometheus/alerting_rules.yml:ro
      - ./greenvalue-ai/infrastructure/monitoring/prometheus/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-admin-api'
    networks:
      - greenvalue-net
    depends_on:
      - greenvalue-ai
      - greenvalue-be
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 7: Grafana (Dashboards & Visualization)
  # Port: 3000
  # ============================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: greenvalue-grafana
    restart: unless-stopped
    ports:
      - "3003:3000"    # 3003 to avoid conflict with NestJS container
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-greenvalue}
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./greenvalue-ai/infrastructure/monitoring/grafana/provisioning/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./greenvalue-ai/infrastructure/monitoring/grafana/provisioning/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./greenvalue-ai/infrastructure/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - greenvalue-net
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Layer 7: cAdvisor (Container Metrics)
  # Port: 8080
  # ============================================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: greenvalue-cadvisor
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - greenvalue-net
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Node Exporter (System Metrics for Prometheus)
  # ============================================================
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: greenvalue-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    networks:
      - greenvalue-net
    profiles:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# Networks
# ============================================================
networks:
  greenvalue-net:
    driver: bridge
    name: greenvalue-network

# ============================================================
# Volumes (Persistent Data)
# ============================================================
volumes:
  # Layer 5: Database
  postgres-data:
    driver: local
  # Cache & Queue
  redis-data:
    driver: local
  # Layer 6: Object Storage
  minio-data:
    driver: local
  # Layer 4: AI Engine
  ai-models:
    driver: local
  ai-yolo-weights:
    driver: local
  ai-logs:
    driver: local
  # Vector DB
  qdrant-data:
    driver: local
  # MLOps
  mlflow-data:
    driver: local
  # Monitoring
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
